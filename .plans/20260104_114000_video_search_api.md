# Issue #60: 映像検索 API 実装計画

**作成日時**: 2026-01-04
**Issue**: #60 映像検索 API
**ブランチ**: `feature/#60-video-search-api`

## 概要

テキストクエリから類似フレームを検索する API エンドポイントを実装する。

## 完了条件

- [x] テキスト → 類似フレーム検索エンドポイント
- [x] 検索結果のスコアリング（類似度）
- [x] ページネーション対応
- [x] プロジェクト/映像単位でのフィルタリング
- [x] ユニットテスト

## 既存実装の活用

すでに以下が実装済み：
- `app/crud/frame.py`: `search_similar_frames()` - pgvector RPC 関数呼び出し
- `app/models/frame.py`: `FrameSimilarityResult` - 類似度検索結果モデル
- `app/ml/siglip/embeddings.py`: `extract_text_embeddings()` - テキスト埋め込み抽出

## 実装詳細

### 1. 新規ファイル: `backend/app/api/v1/search.py`

```python
POST /api/v1/projects/{project_id}/search
```

**リクエスト:**
```json
{
  "query": "cpu",
  "video_id": "optional-video-uuid",
  "limit": 20,
  "offset": 0,
  "min_similarity": 0.0
}
```

**レスポンス:**
```json
{
  "results": [
    {
      "frame_id": "uuid",
      "video_id": "uuid",
      "frame_number": 42,
      "similarity": 0.87,
      "storage_path": "path/to/frame.jpg",
      "thumbnail_url": "presigned-url"
    }
  ],
  "total": 150,
  "has_more": true
}
```

### 2. CRUD 拡張: `backend/app/crud/frame.py`

- `search_similar_frames_filtered()`: video_id フィルタリング対応版
- `count_similar_frames()`: 総件数取得（ページネーション用）

### 3. テスト: `backend/tests/test_api/test_search.py`

- 正常系テスト（検索成功）
- video_id フィルタリングテスト
- min_similarity フィルタリングテスト
- ページネーションテスト
- 認可テスト（他ユーザーのプロジェクト検索不可）

## 実装順序

1. API エンドポイント作成 (`app/api/v1/search.py`)
2. CRUD 関数拡張（video_id フィルタ対応）
3. ルーター登録
4. ユニットテスト作成
5. lint/test 実行

## 注意事項

- テキスト埋め込み抽出は GPU Worker で行う必要があるが、API サーバーからは直接 `extract_text_embeddings()` を呼び出さない
- 代わりに Celery タスクを同期的に実行するか、事前に計算済みの埋め込みを使用
- MVP では簡易的に API サーバー内で CPU 推論を許容する（後で最適化）

## 設計変更点

Issue 仕様からの変更：
- `storage_path` → `s3_key` + `thumbnail_url` に分離（既存パターンに合わせる）
- `min_similarity` のデフォルト値を 0.5 → 0.0 に変更（SigLIP 2 の類似度が低い値になるため）
