# Issue #15: 映像詳細・処理状態 UI 実装計画

**作成日時**: 2025-12-30 10:22
**Issue**: #15 映像詳細・処理状態 UI
**ブランチ**: `feature/#15-video-detail-ui`

## 概要

映像の詳細表示と処理状態の確認 UI を実装する。

## 完了条件

- 映像の詳細情報が表示される
- 処理状態が確認できる
- フレームのサムネイルが表示される

## 依存Issue（完了済み）

- #14 (映像一覧 UI) - ✅ 完了
- #13 (フレーム抽出 Worker) - ✅ 完了

## 現状調査結果

### Backend

| コンポーネント | 状態 |
|--------------|------|
| Frame モデル (`app/models/frame.py`) | ✅ 存在 |
| Frame CRUD (`app/crud/frame.py`) | ✅ 存在 (`get_frames()`) |
| Frame API エンドポイント | ❌ **未実装** |
| Presigned URL生成 (`generate_presigned_download_url`) | ✅ 存在 |

### Frontend

| コンポーネント | 状態 |
|--------------|------|
| Video型定義 | ✅ 存在 |
| getVideo API関数 | ✅ 存在 |
| 映像詳細ページ | ❌ **未実装** |

## 実装ファイル一覧

### Backend 新規作成

| ファイル | 説明 |
|----------|------|
| `backend/app/api/v1/frames.py` | フレーム API エンドポイント |

### Backend 修正

| ファイル | 説明 |
|----------|------|
| `backend/app/api/v1/__init__.py` | frames ルーター登録 |
| `backend/app/core/storage.py` | public endpoint 対応追加 |

### Frontend 新規作成

| ファイル | 説明 |
|----------|------|
| `frontend/src/types/frame.ts` | Frame 型定義 |
| `frontend/src/lib/api/frames.ts` | Frame API クライアント |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/page.tsx` | 映像詳細ページ |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/actions.ts` | Server Actions |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/components/video-detail.tsx` | 映像詳細コンポーネント |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/components/processing-status.tsx` | 処理状態コンポーネント |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/components/frame-grid.tsx` | フレームサムネイル一覧 |

### Frontend 修正

| ファイル | 説明 |
|----------|------|
| `frontend/src/app/(protected)/projects/[id]/components/video-card.tsx` | 詳細ページへのリンク追加 |

## 実装順序

### Step 1: ブランチ作成

```bash
git checkout -b feature/#15-video-detail-ui
```

### Step 2: Backend - Frame API 実装

1. `backend/app/api/v1/frames.py` 作成
   - `GET /api/v1/projects/{project_id}/videos/{video_id}/frames`
   - レスポンスに `thumbnail_url` (presigned URL) を含める
2. `backend/app/api/v1/__init__.py` にルーター登録
3. storage.py の `generate_presigned_download_url` が public endpoint を使うよう修正

### Step 3: Frontend - 型定義・APIクライアント

4. `types/frame.ts` - Frame型定義
5. `lib/api/frames.ts` - getFrames関数

### Step 4: Frontend - 映像詳細ページ

6. ページ・Server Actions 作成
7. video-card.tsx にリンク追加

### Step 5: Frontend - コンポーネント実装

8. `video-detail.tsx` - 映像メタ情報表示
9. `processing-status.tsx` - 処理状態（ポーリング対応）
10. `frame-grid.tsx` - フレームサムネイル一覧

### Step 6: テスト

11. Backend テスト作成・実行
12. Frontend typecheck・lint
13. 手動動作確認

## API 設計

### GET /api/v1/projects/{project_id}/videos/{video_id}/frames

**Response:**
```json
[
  {
    "id": "uuid",
    "video_id": "uuid",
    "frame_number": 0,
    "timestamp_ms": 0,
    "s3_key": "projects/.../frames/000000.jpg",
    "thumbnail_s3_key": "projects/.../thumbnails/000000.jpg",
    "thumbnail_url": "https://...", // Presigned URL
    "width": 1920,
    "height": 1080,
    "created_at": "2025-..."
  }
]
```

## Frontend 型定義

```typescript
// types/frame.ts
export interface Frame {
  id: string;
  video_id: string;
  frame_number: number;
  timestamp_ms: number;
  s3_key: string;
  thumbnail_s3_key: string | null;
  thumbnail_url: string | null; // Presigned URL
  width: number | null;
  height: number | null;
  created_at: string;
}
```

## ポーリング戦略

処理中 (`processing`) の場合:
- 3秒ごとにビデオ状態をポーリング
- `ready` または `failed` になったらポーリング停止
- `ready` の場合はフレーム一覧も取得

## 注意事項

- presigned URL の有効期限は 1 時間（デフォルト）
- サムネイルが多い場合はページネーションを検討（初期実装では100件まで）
- ポーリングは Client Component で useEffect + setInterval で実装
