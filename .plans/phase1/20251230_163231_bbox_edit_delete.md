# Issue #18: バウンディングボックス編集・削除 実装計画

**作成日時**: 2025-12-30 16:32
**Issue**: #18 バウンディングボックス編集・削除
**ブランチ**: `feature/#18-bbox-edit-delete`

## 概要

バウンディングボックス（BBox）の移動・リサイズ・削除機能と Undo/Redo 機能を実装する。

## 完了条件

- BBox を移動・リサイズできる
- Delete キーで BBox を削除できる（既に実装済み）
- Ctrl+Z で操作を元に戻せる
- Ctrl+Shift+Z / Ctrl+Y でやり直しできる

## 既存実装の確認

### 実装済み
- `BoundingBox.tsx`: 選択ハンドル（4隅の四角）の表示
- `AnnotationCanvas.tsx`: 選択・Delete/Backspace での削除
- `DrawingLayer.tsx`: 新規描画機能
- キーボードショートカット: D（描画）、Space/Esc（移動モード）、Delete/Backspace（削除）

### 未実装
- BBox のドラッグ移動
- 角ハンドルによるリサイズ
- Undo/Redo 機能

## 実装計画

### ファイル構成

| ファイル | 説明 |
|----------|------|
| `TransformHandles.tsx` | 移動・リサイズ用のインタラクティブハンドル |
| `hooks/useAnnotationHistory.ts` | Undo/Redo 履歴管理フック |
| `BoundingBox.tsx` | 移動・リサイズ機能の統合（修正） |
| `AnnotationCanvas.tsx` | 履歴管理・キーボードショートカット拡張（修正） |
| `AnnotationToolbar.tsx` | Undo/Redo ボタン追加（修正） |

### Step 1: Undo/Redo 履歴管理フックの作成

`frontend/src/components/annotation/hooks/useAnnotationHistory.ts`

```typescript
interface HistoryState<T> {
  past: T[];
  present: T;
  future: T[];
}

// 機能:
// - push(): 新しい状態を履歴に追加
// - undo(): 1つ前の状態に戻る
// - redo(): 1つ先の状態に進む
// - canUndo, canRedo: 操作可否のフラグ
```

### Step 2: TransformHandles コンポーネントの作成

`frontend/src/components/annotation/TransformHandles.tsx`

```typescript
interface TransformHandlesProps {
  x: number;
  y: number;
  width: number;
  height: number;
  color: string;
  onTransformStart: () => void;
  onTransform: (newBounds: { x: number; y: number; width: number; height: number }) => void;
  onTransformEnd: () => void;
}

// 機能:
// - 4隅のリサイズハンドル（ドラッグ可能）
// - 4辺の中点ハンドル（オプション、将来対応）
// - 中央領域のドラッグ移動
// - ハンドルホバー時のカーソル変更（nw-resize, ne-resize, etc.）
```

### Step 3: BoundingBox.tsx の修正

- `TransformHandles` を統合
- ドラッグ移動イベントの処理
- リサイズイベントの処理
- 選択時のみ編集可能

```typescript
interface BoundingBoxProps {
  data: BoundingBoxData;
  isSelected: boolean;
  onSelect: (id: string) => void;
  onUpdate: (id: string, newData: Partial<BoundingBoxData>) => void; // 追加
  onTransformStart: () => void; // 追加: 履歴保存用
  onTransformEnd: () => void;   // 追加: 履歴確定用
}
```

### Step 4: AnnotationCanvas.tsx の修正

- `useAnnotationHistory` フックの統合
- `onUpdate` ハンドラの追加
- キーボードショートカット拡張:
  - `Ctrl+Z`: Undo
  - `Ctrl+Shift+Z` / `Ctrl+Y`: Redo
- ツールバーへの canUndo/canRedo 状態の伝達

### Step 5: AnnotationToolbar.tsx の修正

- Undo/Redo ボタンの追加
- 無効状態のスタイリング

## 技術的考慮事項

### Konva での移動・リサイズ

- `draggable={true}` でドラッグ有効化
- `onDragStart`, `onDragEnd` でイベント処理
- `dragBoundFunc` で画像領域内に制限

### リサイズの制約

- 最小サイズ: 10x10 ピクセル（`MIN_BOX_SIZE`）
- 画像領域外へのはみ出し禁止
- アスペクト比維持（オプション、Shift キー押下時）

### 履歴管理

- 履歴エントリ: `BoundingBoxData[]` の完全なスナップショット
- 最大履歴数: 50（メモリ効率）
- トランスフォーム中は履歴更新なし（開始時にスナップショット、終了時に確定）

## テスト観点

1. 移動機能
   - BBox をドラッグして移動できること
   - 画像外に移動できないこと

2. リサイズ機能
   - 4隅のハンドルでリサイズできること
   - 最小サイズ以下にならないこと
   - 画像外にリサイズできないこと

3. Undo/Redo
   - Ctrl+Z で直前の操作を取り消せること
   - Ctrl+Y で取り消した操作をやり直せること
   - 新しい操作後に Redo 履歴がクリアされること

4. キーボードショートカット
   - Delete で選択中の BBox が削除されること
   - Esc で選択解除されること

## 実装順序

1. `useAnnotationHistory.ts` - 履歴管理フック
2. `TransformHandles.tsx` - 移動・リサイズハンドル
3. `BoundingBox.tsx` の修正 - TransformHandles 統合
4. `AnnotationCanvas.tsx` の修正 - 履歴管理・イベント処理
5. `AnnotationToolbar.tsx` の修正 - Undo/Redo ボタン
6. テスト・動作確認
7. Lint・型チェック
