# Issue #17: バウンディングボックス描画・選択 実装計画

**作成日時**: 2025-12-30 14:37
**Issue**: #17 #14b バウンディングボックス描画・選択
**ブランチ**: `feature/#17-bounding-box`
**依存**: #16 (基本 Canvas) - 完了済み

## 概要

react-konva を使用してバウンディングボックスの描画・選択機能を実装する。

## 完了条件

- マウスドラッグで BBox を描画できる
- 描画後にラベルを選択できる
- 既存の BBox を選択できる

## 設計方針

### 座標系

- **DB 格納**: 正規化座標 (0-1)
- **Canvas 描画**: 画像ピクセル座標
- 変換は DrawingLayer/BoundingBox 内で行う

### モード管理

- **pan**: キャンバスのドラッグ移動（デフォルト）
- **draw**: BBox 描画モード

### 状態管理

- `annotations`: 既存の BBox 配列
- `selectedId`: 選択中の BBox ID
- `isDrawing`: 描画中フラグ
- `drawingBox`: 描画中の矩形座標
- `mode`: 'pan' | 'draw'

## 実装ファイル一覧

### 新規作成

| ファイル | 説明 |
|----------|------|
| `frontend/src/types/annotation.ts` | アノテーション型定義 |
| `frontend/src/types/label.ts` | ラベル型定義 |
| `frontend/src/lib/api/labels.ts` | ラベル API クライアント |
| `frontend/src/components/annotation/BoundingBox.tsx` | 単一 BBox 表示コンポーネント |
| `frontend/src/components/annotation/DrawingLayer.tsx` | 描画レイヤー |
| `frontend/src/components/annotation/LabelSelectDialog.tsx` | ラベル選択ダイアログ |
| `frontend/src/components/annotation/AnnotationToolbar.tsx` | ツールバー (モード切替) |

### 修正

| ファイル | 説明 |
|----------|------|
| `frontend/src/components/annotation/AnnotationCanvas.tsx` | 状態管理・コンポーネント統合 |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/frames/[frameId]/page.tsx` | ラベル取得追加 |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/frames/[frameId]/actions.ts` | ラベル取得 Server Action |
| `frontend/src/app/(protected)/projects/[id]/videos/[videoId]/frames/[frameId]/annotation-client.tsx` | ラベル props 追加 |

## 型定義

```typescript
// types/annotation.ts
export interface Annotation {
  id: string;
  frame_id: string;
  label_id: string;
  bbox_x: number;      // normalized 0-1
  bbox_y: number;
  bbox_width: number;
  bbox_height: number;
  confidence: number | null;
  source: 'manual' | 'auto' | 'imported';
  reviewed: boolean;
  created_at: string;
}

export interface AnnotationCreate {
  label_id: string;
  bbox_x: number;
  bbox_y: number;
  bbox_width: number;
  bbox_height: number;
}

// Canvas 描画用 (ピクセル座標)
export interface BoundingBoxData {
  id: string;
  x: number;
  y: number;
  width: number;
  height: number;
  labelId: string;
  labelName: string;
  labelColor: string;
}

// types/label.ts
export interface Label {
  id: string;
  project_id: string;
  name: string;
  color: string;
  description: string | null;
  sort_order: number;
  created_at: string;
}
```

## コンポーネント設計

### BoundingBox.tsx

```typescript
interface BoundingBoxProps {
  data: BoundingBoxData;
  isSelected: boolean;
  onSelect: (id: string) => void;
}

// react-konva の Rect + Text で描画
// - 選択時: 太枠 + リサイズハンドル表示
// - hover: カーソル変更
```

### DrawingLayer.tsx

```typescript
interface DrawingLayerProps {
  imageWidth: number;
  imageHeight: number;
  isDrawing: boolean;
  onDrawStart: () => void;
  onDrawEnd: (box: { x: number; y: number; width: number; height: number }) => void;
}

// mousedown/mousemove/mouseup でドラッグ描画
// 描画中は Rect を表示
// 最小サイズ (10x10px) 未満は無視
```

### LabelSelectDialog.tsx

```typescript
interface LabelSelectDialogProps {
  open: boolean;
  labels: Label[];
  onSelect: (labelId: string) => void;
  onCancel: () => void;
}

// shadcn/ui Dialog + ラベル一覧
// 色付きボタンで選択
```

### AnnotationToolbar.tsx

```typescript
interface AnnotationToolbarProps {
  mode: 'pan' | 'draw';
  onModeChange: (mode: 'pan' | 'draw') => void;
}

// 移動モード / 描画モード 切替ボタン
```

## 実装順序

### Step 1: 型定義と API クライアント

1. `types/annotation.ts` - アノテーション型
2. `types/label.ts` - ラベル型
3. `lib/api/labels.ts` - ラベル取得 API

### Step 2: ラベルデータ取得

4. `frames/[frameId]/actions.ts` - fetchLabels Server Action 追加
5. `frames/[frameId]/page.tsx` - ラベル取得・渡し
6. `frames/[frameId]/annotation-client.tsx` - labels props 追加

### Step 3: BBox 表示コンポーネント

7. `BoundingBox.tsx` - 単一 BBox 表示
8. AnnotationCanvas に BBox レイヤー追加（モック表示テスト）

### Step 4: 描画機能

9. `DrawingLayer.tsx` - ドラッグ描画
10. `AnnotationToolbar.tsx` - モード切替
11. AnnotationCanvas に描画レイヤー統合

### Step 5: ラベル選択ダイアログ

12. `LabelSelectDialog.tsx` - ラベル選択 UI
13. 描画完了時にダイアログ表示

### Step 6: 選択機能

14. BBox クリック選択
15. 選択状態のハイライト表示
16. 選択解除（背景クリック）

### Step 7: テストと確認

17. コンポーネントテスト
18. lint/typecheck 通過確認
19. ブラウザ動作確認

## イベントフロー

### 描画フロー

```
1. ユーザーが描画モードに切替
2. Stage の draggable を false に
3. mousedown で描画開始
4. mousemove で矩形を描画
5. mouseup で描画完了
6. LabelSelectDialog を表示
7. ラベル選択で新規 Annotation 作成
   - (今回は API 保存なし、ローカル state のみ)
8. 描画モードを維持 or pan モードに戻す
```

### 選択フロー

```
1. BBox クリック
2. selectedId を更新
3. 選択された BBox をハイライト表示
4. 背景クリックで選択解除
```

## 注意事項

- **API 保存は次の Issue**: 今回はローカル state での管理のみ
- **リサイズ/移動は次の Issue**: #18 で実装
- **削除は次の Issue**: #18 で実装
- ズーム/パン機能との共存を考慮
- 最小サイズ制限 (10x10px) を設ける
