# Issue #21: COCO 形式エクスポート API 実装計画

**作成日時**: 2025-12-30 21:43
**Issue**: #21 COCO 形式エクスポート API
**ブランチ**: `feature/#21-coco-export-api`

## 概要

プロジェクトのアノテーションデータを COCO 形式でエクスポートする API を実装する。

## 完了条件

- COCO 形式の JSON が生成される
- 画像ファイルと一緒に ZIP でダウンロードできる

## COCO 形式仕様

```json
{
    "info": {
        "description": "Exported from Argus",
        "url": "",
        "version": "1.0",
        "year": 2025,
        "contributor": "Argus",
        "date_created": "2025-12-30T00:00:00Z"
    },
    "licenses": [],
    "images": [
        {
            "id": 1,
            "file_name": "frame_0001.jpg",
            "width": 1920,
            "height": 1080
        }
    ],
    "annotations": [
        {
            "id": 1,
            "image_id": 1,
            "category_id": 1,
            "bbox": [100, 200, 300, 400],
            "area": 120000,
            "iscrowd": 0,
            "segmentation": []
        }
    ],
    "categories": [
        {
            "id": 1,
            "name": "person",
            "supercategory": ""
        }
    ]
}
```

## データマッピング

| COCO | Argus DB | 変換 |
|------|----------|------|
| images.id | frame の連番 | 1から連番 |
| images.file_name | frame.s3_key | ファイル名部分のみ |
| images.width/height | frame.width/height | そのまま |
| annotations.id | annotation の連番 | 1から連番 |
| annotations.image_id | frame.id → 連番マップ | frame_id から image_id を検索 |
| annotations.category_id | label.id → 連番マップ | label_id から category_id を検索 |
| annotations.bbox | bbox_x/y/width/height | 正規化座標 → 絶対座標 (pixel) |
| annotations.area | bbox | width * height (pixel) |
| categories.id | label の連番 | 1から連番 |
| categories.name | label.name | そのまま |

## 実装ファイル

### 新規作成

| ファイル | 説明 |
|----------|------|
| `backend/app/services/export/__init__.py` | サービスモジュール |
| `backend/app/services/export/coco.py` | COCO 形式変換ロジック |
| `backend/app/api/v1/export.py` | エクスポート API エンドポイント |
| `backend/tests/test_services/__init__.py` | テストモジュール |
| `backend/tests/test_services/test_export_coco.py` | COCO サービステスト |
| `backend/tests/test_api/test_export.py` | API テスト |

### 修正

| ファイル | 説明 |
|----------|------|
| `backend/app/api/v1/__init__.py` | export_router 追加 |
| `backend/app/main.py` | export_router 登録 |

## API エンドポイント

| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/v1/projects/{project_id}/export/coco` | COCO JSON エクスポート |

### レスポンス

- `Content-Type: application/json`
- COCO 形式の JSON を返す

### 画像 ZIP 同梱 (将来対応)

Issue の要件には「画像ファイルと一緒に ZIP でダウンロードできる」があるが、
MVP では JSON のみとし、画像同梱は別 Issue で対応する。
(S3 から画像をダウンロードする処理が必要で、規模が大きくなるため)

## 実装順序

### Step 1: COCO エクスポートサービス

1. `backend/app/services/__init__.py` 作成
2. `backend/app/services/export/__init__.py` 作成
3. `backend/app/services/export/coco.py` 作成
   - `COCOExporter` クラス
   - `export_project()` メソッド

### Step 2: エクスポート API

4. `backend/app/api/v1/export.py` 作成
   - GET `/projects/{project_id}/export/coco`
5. `backend/app/api/v1/__init__.py` 修正
6. `backend/app/main.py` 修正

### Step 3: テスト

7. `backend/tests/test_services/test_export_coco.py` 作成
8. `backend/tests/test_api/test_export.py` 作成

### Step 4: lint/test/PR

9. lint/format/typecheck 実行
10. テスト実行
11. PR 作成

## 注意事項

- 正規化座標 (0-1) から絶対座標 (pixel) への変換に注意
- frame.width/height が null の場合はエラーまたはスキップ
- アノテーションがないフレームも images に含める
