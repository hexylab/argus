# Issue #56: GPU 環境構築 実装計画

**作成日時**: 2026-01-03 23:12
**更新日時**: 2026-01-04 (分離アーキテクチャに変更)
**Issue**: #56 GPU 環境構築
**ブランチ**: `feature/#56-gpu-environment`

## 概要

SigLIP 2 / SAM 3 の推論を実行するための GPU Worker 環境を構築する。
**依存関係の衝突を避けるため、SigLIP Worker と SAM3 Worker を分離コンテナで実装する。**

## 完了条件

- [x] SigLIP Worker 用 Dockerfile 作成 (`Dockerfile.siglip`)
- [x] SAM3 Worker 用 Dockerfile 作成 (`Dockerfile.sam3`)
- [x] docker-compose.gpu.yml に両サービス追加
- [x] ローカル GPU 対応 (CUDA 12.1+)
- [x] モデルキャッシュ用共有ボリューム設定
- [x] 動作確認スクリプト作成

## 設計

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│ Docker Environment                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   Backend    │  │ CPU Worker   │  │                      │  │
│  │  (FastAPI)   │  │  (Celery)    │  │                      │  │
│  │              │  │              │  │                      │  │
│  │  API         │  │  Frame       │  │                      │  │
│  │  Endpoints   │  │  Extraction  │  │                      │  │
│  │              │  │  (FFmpeg)    │  │                      │  │
│  └──────┬───────┘  └──────┬───────┘  │                      │  │
│         │                 │          │                      │  │
│         └─────────────────┼──────────┘                      │  │
│                           │                                 │  │
│                    ┌──────▼──────┐                          │  │
│                    │    Redis    │                          │  │
│                    │  (Celery)   │                          │  │
│                    │             │                          │  │
│                    │  Queues:    │                          │  │
│                    │  - default  │                          │  │
│                    │  - siglip   │                          │  │
│                    │  - sam3     │                          │  │
│                    └──────┬──────┘                          │  │
│                     ┌─────┴─────┐                           │  │
│                     ▼           ▼                           │  │
│          ┌─────────────────┐ ┌─────────────────┐           │  │
│          │  SigLIP Worker  │ │  SAM3 Worker    │           │  │
│          │     (GPU)       │ │    (GPU)        │           │  │
│          │                 │ │                 │           │  │
│          │  - 特徴抽出     │ │  - 自動アノテ   │           │  │
│          │  - 検索         │ │  - マスク生成   │           │  │
│          │                 │ │                 │           │  │
│          │  transformers   │ │  transformers   │           │  │
│          │  (stable)       │ │  (dev)          │ ← 分離！  │  │
│          │                 │ │                 │           │  │
│          │  Q: siglip      │ │  Q: sam3        │           │  │
│          └────────┬────────┘ └────────┬────────┘           │  │
│                   │                   │                     │  │
│                   └─────────┬─────────┘                     │  │
│                             ▼                               │  │
│                   ┌─────────────────┐                       │  │
│                   │   Model Cache   │                       │  │
│                   │    (Volume)     │                       │  │
│                   │    /models/     │                       │  │
│                   └─────────────────┘                       │  │
└─────────────────────────────────────────────────────────────────┘
```

### 分離の理由

1. **依存関係の衝突回避**
   - SAM 3 は transformers dev 版が必要
   - SigLIP 2 は stable 版で動作
   - 同一コンテナでは競合する

2. **障害分離**
   - 一方がクラッシュしても他に影響なし

3. **独立スケーリング**
   - 負荷に応じて Worker 数を調整可能

4. **GPU 効率化**
   - Celery がタスクをシリアル実行し VRAM 競合を回避

## 実装ファイル

### 新規作成

| ファイル | 説明 |
|----------|------|
| `backend/Dockerfile.siglip` | SigLIP Worker 用 Dockerfile (transformers stable) |
| `backend/Dockerfile.sam3` | SAM3 Worker 用 Dockerfile (transformers dev) |
| `docker/docker-compose.gpu.yml` | GPU サービス定義 (2つの Worker) |
| `backend/scripts/verify_gpu.py` | GPU 動作確認スクリプト |

### 修正

| ファイル | 説明 |
|----------|------|
| `Makefile` | GPU 関連コマンド追加 |
| `backend/ruff.toml` | scripts/ の lint ルール追加 |
| `backend/mypy.ini` | GPU 依存の import 許可 |

## Makefile コマンド

```bash
# GPU 環境を起動 (SigLIP + SAM3)
make up-gpu

# GPU 環境を確認
make verify-gpu

# GPU Workers ログ表示
make logs-gpu

# GPU Workers 再ビルド
make rebuild-gpu

# GPU 環境停止
make down-gpu
```

## 注意事項

- GPU がない環境では `docker-compose.gpu.yml` を使用しない
- NVIDIA Container Toolkit が必要
- 初回起動時は PyTorch とモデルのダウンロードに時間がかかる

## 参照

- r2s2 プロジェクト: `docker/cloud/Dockerfile.sam3`
- NVIDIA Container Toolkit: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/
