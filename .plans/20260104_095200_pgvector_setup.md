# Issue #58: pgvector 設定

**作成日時**: 2026-01-04
**Issue**: #58 pgvector 設定
**ブランチ**: `feature/#58-pgvector-setup`

## 概要

Supabase に pgvector の追加設定を行い、フレームの特徴ベクトルを効率的に検索できるようにする。

## 現状分析

既存マイグレーション (`20251229090535_create_labels_videos_frames_annotations.sql`) で以下は完了済み:

- ✅ `CREATE EXTENSION IF NOT EXISTS vector;`
- ✅ `embedding vector(768)` カラム (frames テーブル)
- ✅ Frame モデル (`embedding: list[float] | None`)

## 完了条件

- [ ] HNSW インデックス作成
- [ ] 類似検索 SQL 関数作成
- [ ] マイグレーションファイル作成
- [ ] Backend での関数呼び出し対応

## 設計

### インデックス選定: HNSW vs IVFFlat

| 項目 | HNSW | IVFFlat |
|------|------|---------|
| クエリ速度 | 高速 | 中程度 |
| メモリ使用量 | 多め | 少なめ |
| インデックス構築 | 遅い | 高速 |
| 事前学習データ | 不要 | 必要 |
| 推奨データ量 | 小〜中規模 | 大規模 |

**選定: HNSW**
- 事前学習データ不要でインデックス作成可能
- 小〜中規模データに最適
- クエリ性能が重要なユースケース

### ベクトル次元数

- SigLIP 2 base model (`google/siglip2-base-patch16-256`): **768次元**
- Issue では 1152 と記載されているが、実装は 768 次元を使用

### 類似検索関数

```sql
CREATE OR REPLACE FUNCTION search_similar_frames(
    query_embedding vector(768),
    project_id_filter UUID,
    limit_count INTEGER DEFAULT 100
)
RETURNS TABLE (
    frame_id UUID,
    video_id UUID,
    frame_number INTEGER,
    s3_key TEXT,
    similarity FLOAT
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT
        f.id,
        f.video_id,
        f.frame_number,
        f.s3_key,
        1 - (f.embedding <=> query_embedding) AS similarity
    FROM public.frames f
    JOIN public.videos v ON v.id = f.video_id
    WHERE v.project_id = project_id_filter
    AND f.embedding IS NOT NULL
    ORDER BY f.embedding <=> query_embedding
    LIMIT limit_count;
END;
$$;
```

### RLS 対応

関数は `SECURITY DEFINER` で定義し、内部で project_id フィルタを適用することで RLS を回避。
呼び出し側で project_id の所有権チェックを行う。

## 実装ファイル

### 新規作成

| ファイル | 説明 |
|----------|------|
| `supabase/migrations/YYYYMMDD_add_pgvector_index_and_function.sql` | HNSW インデックス + 類似検索関数 |
| `backend/app/repositories/frame_search.py` | 類似検索リポジトリ |
| `backend/tests/test_repositories/test_frame_search.py` | リポジトリテスト |

### 修正

| ファイル | 説明 |
|----------|------|
| `docs/design/05_database_schema.md` | インデックス情報を HNSW に更新 |

## 実装順序

1. **Step 1**: マイグレーションファイル作成
   - HNSW インデックス
   - search_similar_frames 関数

2. **Step 2**: Backend リポジトリ作成
   - 類似検索関数の呼び出し
   - 型定義

3. **Step 3**: ユニットテスト作成

4. **Step 4**: 設計ドキュメント更新

5. **Step 5**: lint/test 実行

6. **Step 6**: PR 作成

## 注意事項

- HNSW インデックスは空テーブルでも作成可能
- 類似検索は embedding が NULL のフレームを除外
- SECURITY DEFINER で RLS を回避するため、呼び出し側で認可チェック必須

## 参照

- [pgvector GitHub](https://github.com/pgvector/pgvector)
- [Supabase Vector](https://supabase.com/docs/guides/ai/vector-columns)
- `docs/design/05_database_schema.md`
